# 浏览器以及 html, css, js 解析过程

## 浏览器高层结构

浏览器的主要组件为:

* **用户界面**: 例如前进后退，地址栏，书签菜单等等。
* **浏览器引擎**： 在用户界面和呈现引擎之间传送指令
* **呈现引擎**： 解析 css,html
* **网络**: 发起 http 请求
* **用户界面后端**
* **JavaScript 解释器**
* **数据存储**： 例如 cookie, session等等

![](./img/45.png)

## 浏览器进程

通常下的浏览器进程：

1. **主进程**: 负责用户前进后退，添加书签等等
2. **网络进程**: 负责 http 请求等等
3. **GPU进程**: 负责图片运算等等
4. **渲染进程**： 如果开了多个标签页，就会开启多个渲染进程，除非A 和 B 页面属于同一个站点，并且B 页面是从 A 页面打开，则两个页面共用一个渲染进程。
5. **插件进程**:  如果安装了插件，则插件会开启额外进程
6. **扩展进程**: 如果安装了其他扩展，也会产生额外进程。
7. 如果页面中有 iframe，那么 iframe 也会产生额外进程。



## 浏览器主流程

![](./img/46.png)

可以看到上面HTML和 CSS 都经过 parser(解析)的过程。而解析可以分成两个部分：

* **词法分析**：词法分析是**将输入内容分割成大量标记**的过程。
* **语法分析**：语法分析是**应用语言的语法规则**的过程。

DOM(document object model) 文本对象模型，是 HTML文档的对象表示，同时也是外部内容(例如 javascript)和 HTML元素之间的接口。

### HTML 解析

HTML无法使用传统的解析器进行解析，原因在于：

* 语言的宽容本质
* 浏览器历来对一些常见的无效 HTML 用法采取包容态度。
* 解析可能不断反复并且，js 可能会改变输入内容

因此**浏览器自制了解析器**来解析 HTML，分成两个阶段：**标记化**和**树构建**。

**标记化**：相当于词法分析的过程，将输入内容分解为多个标记。HTML 标记化使用状态机来表示，每个状态根据当前状态接收一个或者多个字符，以决定下一个状态。

**树构建**: 构建解析器的同时，也会创建 document 对象，以 document 为根节点的 dom 树会被不断修改，向其中添加各种元素。



在 HTML 解析完成之后，浏览器会将文档标注为交互状态，并开始解析那些处于“deferred”模式的脚本，也就是那些应在文档解析完成后才执行的脚本。然后，文档状态将设置为“完成”，一个“加载”事件将随之触发。



## CSS 解析

CSS是上下文无关的语法，因此可以使用各种解析器进行解析。解析器会将 css 解析为 Stylesheet 对象。

![](./img/47.png)



## Js 解析

网络模型是同步的，即 Js 的解析会阻塞文档的解析。直到脚本执行完毕。如果脚本是外部的，那么解析过程会停止，直到从网络同步抓取资源完成后再继续。

可以添加 defer 属性，使得脚本程序在文档解析结束之后才继续。H5新增了一个 async 属性，可以将脚本标记为异步，以便由其他线程解析和执行。

### 预解析

webkit 和firefox 都进行了这项优化，在执行脚本的时候，其他线程会解析文档的其余部分，找出并加载需要通过网络加载的其他资源。



## 渲染树

渲染树和 DOM 使对应的，但是并不是一一对应的。非可视化的 DOM 元素不会插入渲染树，例如 head，或者 display 为 none 的元素。







参考: [浏览器的工作原理：新式网络浏览器幕后揭秘](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/)